<!-- LEGACY: ESTA VISTA ESTA EN DESHUSO ACTUALMENTE, se mantiene como referencia -->
{% extends "base.html" %}
{% block title %}Examen OftalmolÃ³gico - Oftalmetryc{% endblock %}

{% block extra_css %}
/* ESTILOS ESPECÃFICOS DE EXAMEN OFTALMOLÃ“GICO */
.page-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.exam-section { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
.section-title { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 20px; font-weight: bold; }
.visual-test-card { background: #f8f9fa; border-radius: 10px; padding: 20px; margin: 15px 0; border-left: 4px solid var(--primary-color); }
.eye-diagram { text-align: center; padding: 30px; background: white; border: 2px dashed #dee2e6; border-radius: 10px; margin: 20px 0; }
.measurement-card { background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
.btn-group-custom { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 20px; }
.small-hint { font-size: .85rem; color: #6c757d; }
{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="page-header d-flex justify-content-between align-items-center">
    <div>
      <h1><i class="fas fa-eye-dropper me-3"></i>Examen OftalmolÃ³gico</h1>
      <p class="mb-0">EvaluaciÃ³n visual y hallazgos clÃ­nicos</p>
    </div>
    <div class="d-flex gap-2">
      <a id="btnNuevaFicha" href="/ficha-clinica-nuevo" class="btn btn-light btn-lg">
        <i class="fas fa-file-medical me-2"></i>Nueva Ficha
      </a>
      <a id="btnVerHistorial" href="/consultas-nuevo" class="btn btn-outline-light btn-lg">
        <i class="fas fa-list me-2"></i>Historial
      </a>
    </div>
  </div>

  <!-- si venimos desde /consultas/<id>/examen -->
  <input type="hidden" id="fichaIdHidden" value="{{ consulta_id|default:'' }}">

  <form id="examenOftalmologicoForm">
    <!-- SELECCIÃ“N / INFORMACIÃ“N DEL PACIENTE -->
    <div class="exam-section">
      <h4 class="section-title"><i class="fas fa-user me-2"></i>Paciente</h4>

      <div class="row g-3">
        <div class="col-md-6">
          <label for="pacienteMedicoId" class="form-label">Buscar paciente por nombre o CÃ©dula/RUC <span class="text-danger">*</span></label>
          <input id="pacienteMedicoId" placeholder="Escribe nombre, cÃ©dula o RUCâ€¦" required>
          <div class="small-hint mt-1">Sugerencias muestran <strong>Nombre â€” CÃ©dula/RUC</strong>. Usa nÃºmeros para buscar por documento.</div>
        </div>
        <div class="col-md-3">
          <label for="pacienteDoc" class="form-label">CÃ©dula/RUC</label>
          <input type="text" id="pacienteDoc" class="form-control" readonly>
        </div>
        <div class="col-md-3">
          <label for="pacienteNombre" class="form-label">Nombre</label>
          <input type="text" id="pacienteNombre" class="form-control" readonly>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-3">
          <label for="fechaExamen" class="form-label">Fecha del Examen</label>
          <input type="datetime-local" class="form-control" id="fechaExamen">
        </div>
        <div class="col-md-9 d-flex align-items-end">
          <div class="small-hint">Al seleccionar un paciente se actualizarÃ¡ el botÃ³n <em>Historial</em> para ir a su historial especÃ­fico.</div>
        </div>
      </div>
    </div>

    <!-- AGUDEZA VISUAL -->
    <div class="exam-section">
      <h4 class="section-title"><i class="fas fa-chart-line me-2"></i>Agudeza Visual</h4>
      <div class="row">
        <div class="col-md-6">
          <div class="visual-test-card">
            <h5 class="text-primary mb-3"><i class="fas fa-eye me-2"></i>Ojo Derecho (OD)</h5>
            <div class="row g-2">
              <div class="col-6">
                <label for="av_od_lejos" class="form-label">Lejos</label>
                <input type="text" class="form-control" id="av_od_lejos" placeholder="20/20">
              </div>
              <div class="col-6">
                <label for="av_od_cerca" class="form-label">Cerca</label>
                <input type="text" class="form-control" id="av_od_cerca" placeholder="J1">
              </div>
            </div>
            <div class="mt-3">
              <label for="av_od_cc" class="form-label">Con correcciÃ³n</label>
              <input type="text" class="form-control" id="av_od_cc" placeholder="20/20">
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="visual-test-card">
            <h5 class="text-primary mb-3"><i class="fas fa-eye me-2"></i>Ojo Izquierdo (OI)</h5>
            <div class="row g-2">
              <div class="col-6">
                <label for="av_oi_lejos" class="form-label">Lejos</label>
                <input type="text" class="form-control" id="av_oi_lejos" placeholder="20/20">
              </div>
              <div class="col-6">
                <label for="av_oi_cerca" class="form-label">Cerca</label>
                <input type="text" class="form-control" id="av_oi_cerca" placeholder="J1">
              </div>
            </div>
            <div class="mt-3">
              <label for="av_oi_cc" class="form-label">Con correcciÃ³n</label>
              <input type="text" class="form-control" id="av_oi_cc" placeholder="20/20">
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-md-12">
          <div class="measurement-card">
            <h6 class="text-info">VisiÃ³n Binocular (AO)</h6>
            <div class="row g-2">
              <div class="col-md-4">
                <label for="av_ao" class="form-label">AO</label>
                <input type="text" class="form-control" id="av_ao" placeholder="20/20">
              </div>
              <div class="col-md-8">
                <label for="av_observaciones" class="form-label">Observaciones</label>
                <input type="text" class="form-control" id="av_observaciones" placeholder="Notas sobre la agudeza visual">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- REFRACCIÃ“N -->
    <div class="exam-section">
      <h4 class="section-title"><i class="fas fa-glasses me-2"></i>RefracciÃ³n</h4>
      <div class="row">
        <div class="col-md-6">
          <div class="measurement-card">
            <h6 class="text-primary">Ojo Derecho (OD)</h6>
            <div class="row g-2">
              <div class="col-4">
                <label for="rx_od_esf" class="form-label">EsfÃ©rico</label>
                <input type="text" class="form-control" id="rx_od_esf" placeholder="-2.50">
              </div>
              <div class="col-4">
                <label for="rx_od_cyl" class="form-label">CilÃ­ndrico</label>
                <input type="text" class="form-control" id="rx_od_cyl" placeholder="-1.00">
              </div>
              <div class="col-4">
                <label for="rx_od_eje" class="form-label">Eje</label>
                <input type="text" class="form-control" id="rx_od_eje" placeholder="90Â°">
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="measurement-card">
            <h6 class="text-primary">Ojo Izquierdo (OI)</h6>
            <div class="row g-2">
              <div class="col-4">
                <label for="rx_oi_esf" class="form-label">EsfÃ©rico</label>
                <input type="text" class="form-control" id="rx_oi_esf" placeholder="-2.50">
              </div>
              <div class="col-4">
                <label for="rx_oi_cyl" class="form-label">CilÃ­ndrico</label>
                <input type="text" class="form-control" id="rx_oi_cyl" placeholder="-1.00">
              </div>
              <div class="col-4">
                <label for="rx_oi_eje" class="form-label">Eje</label>
                <input type="text" class="form-control" id="rx_oi_eje" placeholder="90Â°">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <label for="rx_add" class="form-label">AdiciÃ³n (Lectura)</label>
          <input type="text" class="form-control" id="rx_add" placeholder="+2.00">
        </div>
        <div class="col-md-6">
          <label for="rx_dp" class="form-label">Distancia Pupilar (mm)</label>
          <input type="number" class="form-control" id="rx_dp" placeholder="62">
        </div>
      </div>
    </div>

    <!-- PRESIÃ“N INTRAOCULAR -->
    <div class="exam-section">
      <h4 class="section-title"><i class="fas fa-tachometer-alt me-2"></i>PresiÃ³n Intraocular (PIO)</h4>
      <div class="row g-3">
        <div class="col-md-3">
          <div class="measurement-card">
            <h6 class="text-info">OD</h6>
            <label for="pio_od" class="form-label">mmHg</label>
            <input type="number" class="form-control" id="pio_od" step="0.1" placeholder="15.0">
          </div>
        </div>
        <div class="col-md-3">
          <div class="measurement-card">
            <h6 class="text-info">OI</h6>
            <label for="pio_oi" class="form-label">mmHg</label>
            <input type="number" class="form-control" id="pio_oi" step="0.1" placeholder="15.0">
          </div>
        </div>
        <div class="col-md-3">
          <label for="pio_metodo" class="form-label">MÃ©todo</label>
          <select class="form-select" id="pio_metodo">
            <option value="">Seleccionar</option>
            <option value="goldman">Goldman</option>
            <option value="aire">Por aire</option>
            <option value="palpacion">PalpaciÃ³n</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="pio_hora" class="form-label">Hora</label>
          <input type="time" class="form-control" id="pio_hora">
        </div>
      </div>
    </div>

    <!-- EXAMEN EXTERNO -->
    <div class="exam-section">
      <h4 class="section-title"><i class="fas fa-search me-2"></i>Examen Externo</h4>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="ext_parpados" class="form-label">PÃ¡rpados</label>
          <textarea class="form-control" id="ext_parpados" rows="3" placeholder="PosiciÃ³n, movimiento, lesiones..."></textarea>
        </div>
        <div class="col-md-6">
          <label for="ext_conjuntiva" class="form-label">Conjuntiva</label>
          <textarea class="form-control" id="ext_conjuntiva" rows="3" placeholder="Color, secreciones, lesiones..."></textarea>
        </div>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <label for="ext_cornea" class="form-label">CÃ³rnea</label>
          <textarea class="form-control" id="ext_cornea" rows="3" placeholder="Transparencia, superficie, lesiones..."></textarea>
        </div>
        <div class="col-md-6">
          <label for="ext_pupilas" class="form-label">Pupilas</label>
          <textarea class="form-control" id="ext_pupilas" rows="3" placeholder="TamaÃ±o, forma, reactividad..."></textarea>
        </div>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-md-12">
          <label for="ext_otros" class="form-label">Otros</label>
          <textarea class="form-control" id="ext_otros" rows="3" placeholder="Observaciones adicionales del examen externo..."></textarea>
        </div>
      </div>
    </div>

    <!-- FONDO DE OJO -->
    <div class="exam-section">
      <h4 class="section-title"><i class="fas fa-circle me-2"></i>Fondo de Ojo (OftalmoscopÃ­a)</h4>
      <div class="row">
        <div class="col-md-6">
          <div class="eye-diagram">
            <h6 class="text-primary">Ojo Derecho</h6>
            <i class="fas fa-eye fa-3x text-muted mb-3"></i>
            <textarea class="form-control" id="fondo_od" rows="4" placeholder="Disco Ã³ptico, mÃ¡cula, vasos, retina..."></textarea>
          </div>
        </div>
        <div class="col-md-6">
          <div class="eye-diagram">
            <h6 class="text-primary">Ojo Izquierdo</h6>
            <i class="fas fa-eye fa-3x text-muted mb-3"></i>
            <textarea class="form-control" id="fondo_oi" rows="4" placeholder="Disco Ã³ptico, mÃ¡cula, vasos, retina..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- CONCLUSIONES -->
    <div class="exam-section">
      <h4 class="section-title"><i class="fas fa-clipboard-check me-2"></i>Conclusiones</h4>
      <div class="row g-3">
        <div class="col-md-12">
          <label for="hallazgos" class="form-label">Hallazgos Importantes</label>
          <textarea class="form-control" id="hallazgos" rows="3" placeholder="Resumen de hallazgos relevantes..."></textarea>
        </div>
        <div class="col-md-6">
          <label for="recomendaciones" class="form-label">Recomendaciones</label>
          <textarea class="form-control" id="recomendaciones" rows="3" placeholder="Seguimiento, tratamiento, derivaciones..."></textarea>
        </div>
        <div class="col-md-6">
          <label for="proximo_control" class="form-label">PrÃ³ximo Control</label>
          <input type="date" class="form-control" id="proximo_control">
          <small class="form-text text-muted">Fecha sugerida para el siguiente examen</small>
        </div>
      </div>
    </div>

    <!-- BOTONES -->
    <div class="btn-group-custom">
      <div class="d-flex justify-content-between">
        <div>
          <a href="/dashboard-medico" class="btn btn-outline-secondary me-2">
            <i class="fas fa-arrow-left me-2"></i>Dashboard MÃ©dico
          </a>
          <a id="btnHistorialInferior" href="/consultas-nuevo" class="btn btn-outline-info">
            <i class="fas fa-list me-2"></i>Historial
          </a>
        </div>
        <div>
          <button type="button" class="btn btn-outline-primary me-2" onclick="window.print()">
            <i class="fas fa-print me-2"></i>Imprimir
          </button>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save me-2"></i>Guardar Examen
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- MODAL: Examen guardado -->
<div class="modal fade" id="examenGuardadoModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-check-circle text-success me-2"></i>Examen guardado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        El examen oftalmolÃ³gico fue registrado correctamente.
      </div>
      <div class="modal-footer">
        <button type="button" id="irHistorialBtn" class="btn btn-primary">
          <i class="fas fa-list me-2"></i>Ver Historial
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* ==================== ESTADO ==================== */
let tomSelectPac;
let pacientesMap = new Map(); // key: paciente_medico_id (string) => objeto paciente
let pacienteSeleccionadoId = null;

/* ==================== INIT ==================== */
document.addEventListener('DOMContentLoaded', async function() {
  setFechaActual();
  await cargarPacientesMedicos();
  await prefillPorQuery();
  await actualizarVinculosHistorial();
});

/* ==================== UTILIDADES ==================== */
function setFechaActual() {
  const now = new Date();
  // normalizamos a YYYY-MM-DDTHH:MM:SS sin zona
  const pad = n => String(n).padStart(2, '0');
  const s = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
  document.getElementById('fechaExamen').value = s;
}

function alerta(mensaje, tipo='info') {
  const html = `
    <div class="alert alert-${tipo} alert-dismissible fade show mt-2" role="alert">
      ${mensaje}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  const container = document.querySelector('.container');
  container.insertAdjacentHTML('afterbegin', html);
  setTimeout(() => {
    const a = container.querySelector('.alert');
    if (a) a.remove();
  }, 6000);
}

/* ======== Resolver de URL de historial por paciente (evita 404) ======== */
async function resolverHistorialUrl(pacienteId) {
  if (!pacienteId) return '/consultas-nuevo';
  const id = encodeURIComponent(pacienteId);
  const candidatos = [
    `/pacientes/${id}/historial`,
    `/pacientes-medicos/${id}/historial`,
    `/historial-paciente/${id}`,
    `/historial/${id}`,
    `/consultas?paciente_id=${id}`,
    `/consultas-nuevo?paciente_id=${id}`
  ];
  for (const url of candidatos) {
    try {
      const r = await fetch(url, { method: 'GET', credentials: 'same-origin' });
      if (r.ok) return url;
    } catch(_) {}
  }
  return '/consultas-nuevo';
}

async function actualizarVinculosHistorial() {
  const href = await resolverHistorialUrl(pacienteSeleccionadoId);
  const top = document.getElementById('btnVerHistorial');
  const bottom = document.getElementById('btnHistorialInferior');
  if (top) top.href = href;
  if (bottom) bottom.href = href;
  const irBtn = document.getElementById('irHistorialBtn');
  if (irBtn) irBtn.onclick = () => { window.location.href = href; };
}

/* ==================== PACIENTES: BUSCADOR ==================== */
async function cargarPacientesMedicos() {
  try {
    const res = await fetch('/api/pacientes-medicos');
    if (!res.ok) throw new Error('No fue posible cargar pacientes');
    const json = await res.json().catch(() => ({}));
    const lista = json?.data ?? json ?? [];

    const options = lista.map(p => {
      const id = String(p.paciente_medico_id ?? p.id ?? '');
      const c = p.cliente || p.Cliente || {};
      const doc = c.rut || c.cedula || c.ci || p.rut || p.cedula || p.ci || '';
      const nombre = [c.nombres || p.nombres || '', c.ap_pat || p.ap_pat || '', c.ap_mat || p.ap_mat || ''].filter(Boolean).join(' ').trim();
      const text = `${nombre || 'Sin nombre'} â€” ${doc ? 'CÃ©dula/RUC: '+doc : 'Sin doc.'}`;
      pacientesMap.set(id, { ...p, _doc: doc, _nombre: nombre, _cliente_id: c.cliente_id ?? null });
      return { value: id, text, doc, nombre };
    });

    const input = document.getElementById('pacienteMedicoId');
    tomSelectPac = new TomSelect(input, {
      create: false,
      options,
      searchField: ['text', 'doc', 'nombre'],
      sortField: { field: 'text', direction: 'asc' },
      placeholder: 'Escribe para buscarâ€¦',
      onChange: handleSeleccionPaciente
    });
  } catch (e) {
    alerta('No fue posible preparar el buscador de pacientes', 'danger');
  }
}

function handleSeleccionPaciente(value) {
  pacienteSeleccionadoId = value || null;
  const info = pacientesMap.get(String(value)) || null;
  const doc = info?._doc || '';
  const nombre = info?._nombre || '';

  document.getElementById('pacienteDoc').value = doc || '';
  document.getElementById('pacienteNombre').value = nombre || '';

  actualizarVinculosHistorial();
}

/* ==================== PREFILL POR QUERY ==================== */
async function prefillPorQuery() {
  const params = new URLSearchParams(window.location.search);
  const qPacienteId = params.get('paciente_id');
  if (qPacienteId && tomSelectPac) {
    tomSelectPac.setValue(String(qPacienteId), true);
    tomSelectPac.disable(); // bloquea cambio si viene fijado
    handleSeleccionPaciente(String(qPacienteId));
  }
}

/* ==================== GUARDAR EXAMEN (con fallbacks) ==================== */
async function postExam(payload) {
  // La API legacy `/api/examenes-oftalmologicos` pertenecía al proyecto Flask original.
  // Aún no existe una vista equivalente en Django, por lo que dejamos este bloque
  // deshabilitado para evitar peticiones 404 hasta que se implemente el endpoint nuevo.
  /*
  const r = await fetch('/api/examenes-oftalmologicos', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const body = await r.json().catch(() => ({}));
  */
  return { ok: r.ok, status: r.status, body };
}

document.getElementById('examenOftalmologicoForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  if (!pacienteSeleccionadoId) {
    alerta('Selecciona un paciente antes de guardar.', 'danger');
    return;
  }

  const ficha_id = document.getElementById('fichaIdHidden').value || null;
  const info = pacientesMap.get(String(pacienteSeleccionadoId)) || {};
  const doc = info?._doc || null;
  const clienteId = info?._cliente_id || null;

  const fechaVal = document.getElementById('fechaExamen').value || null;
  // asegurar segundos presentes
  const fecha_examen = fechaVal && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(fechaVal)
    ? `${fechaVal}:00`
    : fechaVal;

  const basePayload = {
    fecha_examen,
    estado: 'registrado',

    // Agudeza visual
    av_od_lejos: document.getElementById('av_od_lejos').value || null,
    av_od_cerca: document.getElementById('av_od_cerca').value || null,
    av_od_cc: document.getElementById('av_od_cc').value || null,
    av_oi_lejos: document.getElementById('av_oi_lejos').value || null,
    av_oi_cerca: document.getElementById('av_oi_cerca').value || null,
    av_oi_cc: document.getElementById('av_oi_cc').value || null,
    av_ao: document.getElementById('av_ao').value || null,
    av_observaciones: document.getElementById('av_observaciones').value || null,

    // RefracciÃ³n
    rx_od_esf: document.getElementById('rx_od_esf').value || null,
    rx_od_cyl: document.getElementById('rx_od_cyl').value || null,
    rx_od_eje: document.getElementById('rx_od_eje').value || null,
    rx_oi_esf: document.getElementById('rx_oi_esf').value || null,
    rx_oi_cyl: document.getElementById('rx_oi_cyl').value || null,
    rx_oi_eje: document.getElementById('rx_oi_eje').value || null,
    rx_add: document.getElementById('rx_add').value || null,
    rx_dp: document.getElementById('rx_dp').value || null,

    // PIO
    pio_od: document.getElementById('pio_od').value || null,
    pio_oi: document.getElementById('pio_oi').value || null,
    pio_metodo: document.getElementById('pio_metodo').value || null,
    pio_hora: document.getElementById('pio_hora').value || null,

    // Examen externo
    ext_parpados: document.getElementById('ext_parpados').value || null,
    ext_conjuntiva: document.getElementById('ext_conjuntiva').value || null,
    ext_cornea: document.getElementById('ext_cornea').value || null,
    ext_pupilas: document.getElementById('ext_pupilas').value || null,

    // Fondo de ojo
    fondo_od: document.getElementById('fondo_od').value || null,
    fondo_oi: document.getElementById('fondo_oi').value || null,

    // Conclusiones
    hallazgos: document.getElementById('hallazgos').value || null,
    recomendaciones: document.getElementById('recomendaciones').value || null,
    proximo_control: document.getElementById('proximo_control').value || null,
  };

  // id de relaciÃ³n (prioridad: paciente_medico_id -> paciente_id -> cliente_id -> paciente_rut)
  const variantes = [];
  variantes.push({
    ...(ficha_id ? { consulta_id: parseInt(ficha_id, 10) } : {}),
    paciente_medico_id: parseInt(pacienteSeleccionadoId, 10),
    ...basePayload
  });
  variantes.push({
    ...(ficha_id ? { consulta_id: parseInt(ficha_id, 10) } : {}),
    paciente_id: parseInt(pacienteSeleccionadoId, 10),
    ...basePayload
  });
  if (clienteId) {
    variantes.push({
      ...(ficha_id ? { consulta_id: parseInt(ficha_id, 10) } : {}),
      cliente_id: parseInt(clienteId, 10),
      ...basePayload
    });
  }
  if (doc) {
    variantes.push({
      ...(ficha_id ? { consulta_id: parseInt(ficha_id, 10) } : {}),
      paciente_rut: String(doc),
      ...basePayload
    });
  }

  const submitBtn = this.querySelector('button[type="submit"]');
  submitBtn.disabled = true;

  let ultimoError = null;
  for (let i = 0; i < variantes.length; i++) {
    try {
      const intento = await postExam(variantes[i]);
      if (intento.ok) {
        // Ã‰xito -> modal + redirecciÃ³n al historial vÃ¡lido
        const modalEl = document.getElementById('examenGuardadoModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        const href = await resolverHistorialUrl(pacienteSeleccionadoId);
        const irBtn = document.getElementById('irHistorialBtn');
        if (irBtn) irBtn.onclick = () => { window.location.href = href; };

        setTimeout(() => { window.location.href = href; }, 1500);
        return;
      } else {
        ultimoError = intento;
        // Si fue 400, seguimos probando la siguiente variante
        if (intento.status !== 400) break;
      }
    } catch (err) {
      ultimoError = { status: 0, body: { message: err?.message || 'Fallo de red' } };
      break;
    }
  }

  submitBtn.disabled = false;
  const msg = (ultimoError && (ultimoError.body?.message || ultimoError.body?.error)) ?
              ultimoError.body.message || ultimoError.body.error :
              'Respuesta no vÃ¡lida';
  alerta(`Error al guardar el examen: ${msg}`, 'danger');
});
</script>
{% endblock %}


