{% extends "base.html" %}

{% block title %}Detalle de Consulta - Oftalmetryc{% endblock %}

{% block extra_css %}
/* ESTILOS ESPECÍFICOS DE DETALLE DE CONSULTA */
.page-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.info-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}
.section-title {
    color: var(--primary-color);
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 10px;
    margin-bottom: 20px;
    font-weight: bold;
}
.info-label { font-weight: bold; color: #555; }
.info-value { color: #333; }
.eye-section {
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 15px;
    margin-top: 10px;
}
.eye-section h6 { font-weight: bold; }
{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- HEADER DE LA PÁGINA -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-file-medical-alt me-3"></i>Detalle de Consulta</h1>
                <p class="mb-0" id="consultaSubtitle">Revisión completa de la ficha clínica</p>
            </div>
            <div>
                <a href="{% url 'medical:consultas' %}" class="btn btn-light me-2">
                    <i class="fas fa-arrow-left me-2"></i>Volver al Historial
                </a>
                <div class="btn-group">
                    <button class="btn btn-outline-light" onclick="editarConsulta()">
                        <i class="fas fa-edit me-2"></i>Editar
                    </button>
                    <button class="btn btn-outline-light" onclick="imprimirFicha()">
                        <i class="fas fa-print me-2"></i>Imprimir Ficha
                    </button>
                    <a href="#" id="generateCertificateBtn" class="btn btn-warning">
                        <i class="fas fa-file-medical me-2"></i>Generar Certificado
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN DE CARGA / ERROR -->
    <div id="loadingSection" class="text-center py-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="text-muted mt-3">Cargando información de la consulta...</p>
    </div>

    <div id="errorSection" class="alert alert-danger text-center" style="display:none;">
        <span id="errorMessage"></span>
    </div>

    <!-- CONTENIDO DE LA CONSULTA -->
    <div id="consultaContent" style="display:none;">
        <!-- INFORMACIÓN GENERAL -->
        <div class="info-section">
            <div class="row">
                <div class="col-md-8">
                    <h5 class="section-title">Información General</h5>
                    <p><strong class="info-label">Paciente:</strong> <span id="patientName" class="info-value"></span></p>
                    <p><strong class="info-label">Médico:</strong> <span id="nombreMedico" class="info-value"></span></p>
                    <p><strong class="info-label">Motivo de Consulta:</strong> <span id="motivoConsulta" class="info-value"></span></p>
                </div>
                <div class="col-md-4 text-md-end">
                    <p><strong class="info-label">N° Ficha:</strong> <span id="numeroFicha" class="info-value"></span></p>
                    <p><strong class="info-label">Fecha:</strong> <span id="fechaConsulta" class="info-value"></span></p>
                    <p><strong class="info-label">Hora:</strong> <span id="horaConsulta" class="info-value"></span></p>
                </div>
            </div>
        </div>

        <!-- EXAMEN VISUAL -->
        <div class="info-section">
            <h5 class="section-title">Examen Visual</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="eye-section">
                        <h6><i class="fas fa-eye me-2 text-primary"></i>Agudeza Visual (Ojo Derecho)</h6>
                        <p><strong>Sin Corrección:</strong> <span id="avOdSc">-</span></p>
                        <p><strong>Con Corrección:</strong> <span id="avOdCc">-</span></p>
                        <p><strong>Pinhole:</strong> <span id="avOdPh">-</span></p>
                        <p class="mb-0"><strong>Visión de Cerca:</strong> <span id="avOdCerca">-</span></p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="eye-section">
                        <h6><i class="fas fa-eye me-2 text-success"></i>Agudeza Visual (Ojo Izquierdo)</h6>
                        <p><strong>Sin Corrección:</strong> <span id="avOiSc">-</span></p>
                        <p><strong>Con Corrección:</strong> <span id="avOiCc">-</span></p>
                        <p><strong>Pinhole:</strong> <span id="avOiPh">-</span></p>
                        <p class="mb-0"><strong>Visión de Cerca:</strong> <span id="avOiCerca">-</span></p>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="eye-section">
                        <h6><i class="fas fa-glasses me-2 text-primary"></i>Refracción Final (Ojo Derecho)</h6>
                        <p><strong>Esfera:</strong> <span id="esferaOd">-</span> | <strong>Cilindro:</strong> <span id="cilindroOd">-</span> | <strong>Eje:</strong> <span id="ejeOd">-</span></p>
                        <p class="mb-0"><strong>Adición:</strong> <span id="adicionOd">-</span></p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="eye-section">
                        <h6><i class="fas a-glasses me-2 text-success"></i>Refracción Final (Ojo Izquierdo)</h6>
                        <p><strong>Esfera:</strong> <span id="esferaOi">-</span> | <strong>Cilindro:</strong> <span id="cilindroOi">-</span> | <strong>Eje:</strong> <span id="ejeOi">-</span></p>
                        <p class="mb-0"><strong>Adición:</strong> <span id="adicionOi">-</span></p>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12"><p><strong>Distancia Pupilar:</strong> <span id="distanciaPupilar">-</span></p></div>
            </div>
        </div>

        <!-- CONCLUSIÓN -->
        <div class="info-section">
            <h5 class="section-title">Conclusión Clínica</h5>
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-diagnoses me-2"></i>Diagnóstico</h6>
                    <p id="diagnostico">-</p>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-pills me-2"></i>Tratamiento y Recomendaciones</h6>
                    <p id="tratamiento">-</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ID recibido desde la URL por Jinja
    const consultaId = {{ consulta_id|tojson }};

    // Endpoints generados con url_for para evitar hardcodear rutas y respetar el blueprint/prefijos
    const API_GET_BY_ID_TEMPLATE = "{% url 'medical:api_ficha_clinica_by_id' ficha_id=0 %}";
    const API_GET_BY_ID_URL = API_GET_BY_ID_TEMPLATE.replace('/0', '/' + consultaId);

    const EDIT_URL_TEMPLATE = "{% url 'medical:editar_consulta' consulta_id=0 %}";
    const CERT_URL_TEMPLATE = "{% url 'medical:certificado' consulta_id=0 %}";

    document.addEventListener('DOMContentLoaded', () => {
        if (consultaId) {
            cargarConsulta();
        } else {
            mostrarError('ID de consulta no válido.');
        }
    });

    // Helpers para lectura segura
    function getByPath(obj, path) {
        return path.split('.').reduce((o, k) =>
            (o && o[k] !== undefined && o[k] !== null && o[k] !== '') ? o[k] : undefined, obj);
    }
    function pick(obj, paths, fallback='-') {
        for (const p of paths) {
            const v = getByPath(obj, p);
            if (v !== undefined) return v;
        }
        return fallback;
    }

    async function cargarConsulta() {
        try {
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('consultaContent').style.display = 'none';

            const response = await fetch(API_GET_BY_ID_URL, { headers: { 'Accept': 'application/json' } });
            if (!response.ok) throw new Error(`Error en la respuesta de la API: ${response.status} ${response.statusText}`);

            const payload = await response.json();
            // Aceptar 'data' o 'ficha_clinica'
            const consulta = (payload && payload.data) ? payload.data
                            : (payload && payload.ficha_clinica) ? payload.ficha_clinica
                            : null;

            if (payload && payload.success && consulta) {
                mostrarInformacion(consulta);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('consultaContent').style.display = 'block';
            } else {
                mostrarError((payload && (payload.error || payload.message)) || 'No se pudo cargar la consulta.');
            }
        } catch (error) {
            console.error('Error:', error);
            mostrarError('Error de conexión al cargar la consulta.');
        }
    }

    function mostrarInformacion(consulta) {
        // Paciente
        const nombres = pick(consulta, ['cliente.nombres','paciente_medico.cliente.nombres'], '-');
        const apPat   = pick(consulta, ['cliente.ap_pat','paciente_medico.cliente.ap_pat'], '');
        document.getElementById('patientName').textContent = `${nombres} ${apPat}`.trim() || '-';

        // Fecha/hora
        const fechaIso = consulta.fecha_consulta;
        const fecha = fechaIso ? new Date(fechaIso) : null;
        document.getElementById('consultaSubtitle').textContent = fecha ? `Consulta del ${fecha.toLocaleDateString('es-CL')}` : 'Consulta';
        document.getElementById('numeroFicha').textContent = pick(consulta, ['paciente_medico.numero_ficha'], '-');
        document.getElementById('fechaConsulta').textContent = fecha ? fecha.toLocaleDateString('es-CL') : '-';
        document.getElementById('horaConsulta').textContent  = fecha ? fecha.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' }) : '-';

        // Usuario
        document.getElementById('nombreMedico').textContent = pick(consulta, ['usuario.nombre'], '-');

        // Motivo
        document.getElementById('motivoConsulta').textContent = pick(consulta, ['motivo_consulta'], '-');

        // AV
        document.getElementById('avOdSc').textContent    = pick(consulta, ['av_od_sc']);
        document.getElementById('avOdCc').textContent    = pick(consulta, ['av_od_cc']);
        document.getElementById('avOdPh').textContent    = pick(consulta, ['av_od_ph']);
        document.getElementById('avOdCerca').textContent = pick(consulta, ['av_od_cerca']);
        document.getElementById('avOiSc').textContent    = pick(consulta, ['av_oi_sc']);
        document.getElementById('avOiCc').textContent    = pick(consulta, ['av_oi_cc']);
        document.getElementById('avOiPh').textContent    = pick(consulta, ['av_oi_ph']);
        document.getElementById('avOiCerca').textContent = pick(consulta, ['av_oi_cerca']);

        // Rx
        document.getElementById('esferaOd').textContent   = pick(consulta, ['esfera_od']);
        document.getElementById('cilindroOd').textContent = pick(consulta, ['cilindro_od']);
        document.getElementById('ejeOd').textContent      = pick(consulta, ['eje_od']);
        document.getElementById('adicionOd').textContent  = pick(consulta, ['adicion_od']);
        document.getElementById('esferaOi').textContent   = pick(consulta, ['esfera_oi']);
        document.getElementById('cilindroOi').textContent = pick(consulta, ['cilindro_oi']);
        document.getElementById('ejeOi').textContent      = pick(consulta, ['eje_oi']);
        document.getElementById('adicionOi').textContent  = pick(consulta, ['adicion_oi']);
        document.getElementById('distanciaPupilar').textContent = pick(consulta, ['distancia_pupilar']);

        // Conclusión
        document.getElementById('diagnostico').textContent = pick(consulta, ['diagnostico']);
        document.getElementById('tratamiento').textContent = pick(consulta, ['tratamiento']);

        // Botón de certificado (ruta real via url_for)
        const fichaId = pick(consulta, ['ficha_id'], null);
        const btn = document.getElementById('generateCertificateBtn');
        if (fichaId) {
            btn.href = CERT_URL_TEMPLATE.replace('/0', '/' + fichaId);
            btn.classList.remove('disabled');
        } else {
            btn.href = '#';
            btn.classList.add('disabled');
        }
    }

    function mostrarError(mensaje) {
        document.getElementById('loadingSection').style.display = 'none';
        document.getElementById('consultaContent').style.display = 'none';
        document.getElementById('errorSection').style.display = 'block';
        document.getElementById('errorMessage').textContent = mensaje || 'Ocurrió un error.';
    }

    // Navegación
    function editarConsulta() {
        window.location.href = EDIT_URL_TEMPLATE.replace('/0', '/' + consultaId);
    }
    function imprimirFicha() { window.print(); }
</script>
{% endblock %}

